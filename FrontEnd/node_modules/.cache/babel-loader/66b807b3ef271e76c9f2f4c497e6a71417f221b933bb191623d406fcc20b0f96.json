{"ast":null,"code":"const express = require(\"express\");\nconst route = express.Router();\nconst bcrypt = require(\"bcrypt\");\nconst mongo = require(\"mongoose\");\nconst jwt = require(\"jsonwebtoken\");\nconst User = require(\"../model/user\");\nconst user = require(\"../model/user\");\nmongo.set(\"strictQuery\", false);\nmongo.connect(\"mongodb+srv://vandy:khmergamer@cluster0.63zqaij.mongodb.net/User?retryWrites=true&w=majority\", {\n  useNewUrlParser: true\n}).then(() => {\n  console.log(\"Connected to database\");\n}).catch(err => {\n  console.log(\"Erro\" + err);\n});\nroute.post(\"/register\", (req, res) => {\n  User.findOne({\n    email: req.body.email\n  }, (err, existingUser) => {\n    if (err) {\n      res.status(500).send(err);\n    } else if (existingUser) {\n      res.status(409).json({\n        message: \"User with this email already exists\"\n      });\n    } else {\n      const user = new User({\n        email: req.body.email,\n        password: bcrypt.hashSync(req.body.password, 10)\n      });\n      user.save(err => {\n        if (err) {\n          res.status(500).send(err);\n        } else {\n          res.status(201).json({\n            message: \"User created\"\n          });\n        }\n      });\n    }\n  });\n});\nroute.post(\"/login\", (req, res) => {\n  User.findOne({\n    email: req.body.email\n  }, (err, user) => {\n    if (err) {\n      res.status(500).send(err);\n    } else if (!user) {\n      res.status(404).json({\n        message: \"User not found\"\n      });\n    } else {\n      if (bcrypt.compareSync(req.body.password, user.password)) {\n        //update user's isLoggedIn status\n        User.updateOne({\n          _id: user._id\n        }, {\n          $set: {\n            isLoggedIn: true\n          }\n        }, (err, updatedUser) => {\n          if (err) {\n            res.status(500).send(err);\n          } else {\n            const token = jwt.sign({\n              email: user.email\n            }, \"secret\", {\n              expiresIn: \"7200\"\n            });\n            res.json({\n              message: \"Login succesfully\",\n              token: token\n            });\n            localStorage.setItem(\"token\", res.data.token);\n          }\n        });\n      } else {\n        res.status(401).json({\n          message: \"Auth failed\"\n        });\n      }\n    }\n  });\n});\nroute.get(\"/user\", (req, res) => {\n  User.find({}).then(user => {\n    res.status(200).json({\n      message: \"User retrieved successfully\",\n      user: user\n    });\n  }).catch(err => {\n    res.status(500).json({\n      message: \"Error retrieving users\",\n      err: err\n    });\n  });\n});\nmodule.exports = route;","map":{"version":3,"names":["express","require","route","Router","bcrypt","mongo","jwt","User","user","set","connect","useNewUrlParser","then","console","log","catch","err","post","req","res","findOne","email","body","existingUser","status","send","json","message","password","hashSync","save","compareSync","updateOne","_id","$set","isLoggedIn","updatedUser","token","sign","expiresIn","localStorage","setItem","data","get","find","module","exports"],"sources":["C:/Ecommerce Project/BackEnd/route/auth.js"],"sourcesContent":["const express = require(\"express\");\r\nconst route = express.Router();\r\nconst bcrypt = require(\"bcrypt\");\r\nconst mongo = require(\"mongoose\");\r\nconst jwt = require(\"jsonwebtoken\");\r\nconst User = require(\"../model/user\");\r\nconst user = require(\"../model/user\");\r\n\r\nmongo.set(\"strictQuery\", false);\r\nmongo\r\n  .connect(\r\n    \"mongodb+srv://vandy:khmergamer@cluster0.63zqaij.mongodb.net/User?retryWrites=true&w=majority\",\r\n    { useNewUrlParser: true }\r\n  )\r\n  .then(() => {\r\n    console.log(\"Connected to database\");\r\n  })\r\n  .catch((err) => {\r\n    console.log(\"Erro\" + err);\r\n  });\r\n\r\nroute.post(\"/register\", (req, res) => {\r\n  User.findOne({ email: req.body.email }, (err, existingUser) => {\r\n    if (err) {\r\n      res.status(500).send(err);\r\n    } else if (existingUser) {\r\n      res.status(409).json({\r\n        message: \"User with this email already exists\",\r\n      });\r\n    } else {\r\n      const user = new User({\r\n        email: req.body.email,\r\n        password: bcrypt.hashSync(req.body.password, 10),\r\n      });\r\n      user.save((err) => {\r\n        if (err) {\r\n          res.status(500).send(err);\r\n        } else {\r\n          res.status(201).json({\r\n            message: \"User created\",\r\n          });\r\n        }\r\n      });\r\n    }\r\n  });\r\n});\r\n\r\nroute.post(\"/login\", (req, res) => {\r\n  User.findOne({ email: req.body.email }, (err, user) => {\r\n    if (err) {\r\n      res.status(500).send(err);\r\n    } else if (!user) {\r\n      res.status(404).json({\r\n        message: \"User not found\",\r\n      });\r\n    } else {\r\n      if (bcrypt.compareSync(req.body.password, user.password)) {\r\n        //update user's isLoggedIn status\r\n        User.updateOne(\r\n          { _id: user._id },\r\n          { $set: { isLoggedIn: true } },\r\n          (err, updatedUser) => {\r\n            if (err) {\r\n              res.status(500).send(err);\r\n            } else {\r\n              const token = jwt.sign({ email: user.email }, \"secret\", {\r\n                expiresIn: \"7200\",\r\n              });\r\n              res.json({\r\n                message: \"Login succesfully\",\r\n                token: token,\r\n              });\r\n              localStorage.setItem(\"token\", res.data.token);\r\n            }\r\n          }\r\n        );\r\n      } else {\r\n        res.status(401).json({\r\n          message: \"Auth failed\",\r\n        });\r\n      }\r\n    }\r\n  });\r\n});\r\n\r\nroute.get(\"/user\", (req, res) => {\r\n  User.find({})\r\n    .then((user) => {\r\n      res.status(200).json({\r\n        message: \"User retrieved successfully\",\r\n        user: user,\r\n      });\r\n    })\r\n    .catch((err) => {\r\n      res.status(500).json({\r\n        message: \"Error retrieving users\",\r\n        err: err,\r\n      });\r\n    });\r\n});\r\n\r\nmodule.exports = route;\r\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}